# **期末專案：AI 圖像風格轉換平台**

------

## **專案緣起：在 Colab 環境中自訂 AI 圖像生成介面**

本專案旨在 Google Colab 環境中，實作一個具備自訂介面的 AI 圖像生成平台。目前市面上常見的 AI 圖像生成工具多為預設功能，單向操作，缺乏自訂彈性。本專案目的為探索 Colab 雲端環境中，整合圖像生成模型與客製化交互介面，並開發記憶用戶偏好的功能。此過程涉及 Colab 部署問題與錯誤排除，本報告將闡述相關實作經驗及最終成果。

------

## **一、 專案核心技術與模型選擇**

本專案主要使用 **Stable Diffusion (SD) 擴散模型家族中的 `StableDiffusionImg2ImgPipeline`**。此模型具備基於輸入圖像、文字提示及指定風格生成新圖像的能力。

專案主要仰賴以下函式庫：

- **`diffusers` 函式庫：** 提供 Stable Diffusion 模型的核心功能封裝，簡化圖像生成流程。
- **`transformers` 函式庫：** 負責將文字提示（Prompt）轉換為模型可理解的輸入格式。
- **`torch` (PyTorch 深度學習框架)：** 負責底層張量運算及 GPU 資源調用，是 AI 模型運行的基礎。

**關於 Foocus 等預配置工具的考量：** 在開發初期，曾評估 Foocus 等預配置 Colab 解決方案。然而，考量到其初始安裝檔案較大，且對於使用免費 Colab 資源構成負擔。本專案重點為探索與實踐交互功能開發，而非單純追求生成圖片品質或易用性，故選擇自主建構環境以提升開發彈性。

------

## **二、 專案目的**

本專案目標明確，但在 Colab 環境中實作涉及多項技術挑戰：

**核心目的：在單一 Colab 筆記本中，建構以下功能：**

1. **圖像生成平台：** 實現 AI 圖像風格轉換功能。
2. **Gradio 介面串接：** 提供客製化網頁操作介面。
3. **Colab 環境穩定化：** 解決 Colab 部署問題，確保系統穩定運行，並提供可外部訪問的網址。

本專案旨在不依賴現成套裝軟體，自主整合圖像生成核心、自訂介面及環境配置，並確保其穩定運行。

------

## **三、 專案實作歷程：錯誤排除與環境調整**

本專案的實作過程，主要為分析 Colab 環境特性並排除運行時錯誤。相關問題及解決方案如下：

### **3.1. 環境配置中的關鍵問題：`torch`、`numpy` 與二進制兼容性**

這些函式庫及相關兼容性問題在 Colab 環境中構成核心技術挑戰。

- **`torch` (PyTorch) 的模組加載行為：**
  - **觀察狀況：** 執行 `!pip install torch` 後，仍出現 `ModuleNotFoundError: No module named 'torch'` 或 `CUDA is not available`。
  - **分析：** `torch` 包含底層二進制組件，`pip` 安裝後，Python 解釋器需重啟才能正確加載。此外，`torch` 版本需與 Colab 的 CUDA 版本精確匹配。
  - **修正動作：** 程式碼中加入 `sys.exit(0)` 強制 Colab 運行時重啟；安裝時指定 `--index-url https://download.pytorch.org/whl/cu121` 確保 CUDA 版本匹配。
- **`numpy` (數值計算基礎函式庫) 的潛在問題：**
  - **觀察狀況：** 運行時出現 `numpy.dtype size changed` 或 `onnxruntime`（`diffusers` 內部依賴）與 `numpy` 版本不兼容的錯誤。
  - **分析：** 此為二進制兼容性問題，表示函式庫編譯時所依賴的 `numpy` 版本與運行時載入的版本不一致。
  - **修正動作：** 實施「徹底卸載舊版 `numpy`，精確安裝兼容版本」的策略 (`!pip uninstall -y numpy` 後 `!pip install numpy==1.26.4`)。
- **應對「二進制兼容問題」的整合方案：**
  - **觀察狀況：** 多個 `ModuleNotFoundError` 和函式庫衝突問題同時存在。
  - **分析：** 問題源於底層函式庫與運行環境的規格不符。
  - **修正動作：** 將所有 `!pip install` 指令及 `os.environ` 環境設定（包括 CUDA 路徑）集中於**第一個 Cell**。在此 Cell 末尾執行一次 `sys.exit(0)`，確保所有函式庫在一次性完整配置後，於重啟的乾淨環境中正確加載。

### **3.2. Colab 運行機制理解與除錯策略**

本專案的除錯過程，是基於對 Colab 運行機制特性的理解。

1. **「多階段重啟」的無效性：**
   - **觀察狀況：** 嘗試分步安裝並多次重啟 (`sys.exit(0)`)，但函式庫仍無法穩定加載。
   - **分析：** Colab 的 `sys.exit(0)` 會導致運行時完全重置，而非累積進度，造成安裝成果被清除。
   - **修正：** 採納「所有安裝一次完成，一次性重啟」策略，確保所有函式庫在單次重啟後生效。
2. **自主控制環境的必要性：**
   - **觀察狀況：** 預配置工具（如 Foocus）雖便捷，但無法提供底層環境細節的控制權。
   - **分析：** 在需要自訂介面及功能整合時，對函式庫版本及環境配置的精確控制至關重要。
   - **修正：** 選擇自主建構環境，直接解決 Colab 環境的兼容性問題，以實現自訂介面及功能的整合目標。

## **四、 專案最終成果：AI 圖像風格轉換平台**

### **4.1. 核心功能展示：風格轉換與回饋學習**

1. **初始生成：無回饋狀態**
   - 使用者選取風格、輸入關鍵字。此時右側「正面」/「負面」關鍵字顯示區為空。
   - 系統基於輸入生成圖片。
   - ![](https://camo.githubusercontent.com/fd64547c83665f98a783ae89e8f95604afb1615446adaf2c5bd81c864e7f1a26/68747470733a2f2f692e6d6565652e636f6d2e74772f613741746b50672e706e67)
2. **回饋介入：記錄用戶偏好**
   - 若對生成圖片滿意（例如，符合「長髮女孩」描述），可選擇「喜歡」並點擊「反饋」。
   - 右側「正面關鍵字」區將記錄該次滿意生成所對應的關鍵字（如「長髮」）。
   - ![](https://camo.githubusercontent.com/15930fdb1b52739b7829fa3a75da307bdddbf7c4ee4fb1b09989724b4374b215/68747470733a2f2f692e6d6565652e636f6d2e74772f796c417a4a74612e706e67)
3. **基於回饋的動態生成：圖像結果受累積偏好影響**
   - 清空輸入關鍵字後再次生成。
   - 系統將自動參考「正面」區累積的關鍵字（例如「長髮」）。
   - 即使未再次輸入該關鍵字，生成的圖片仍會傾向於呈現相關特徵（如長髮角色），證明回饋機制能有效影響後續生成結果。
   - ![](https://camo.githubusercontent.com/a2c77503fd54ef59a27c57f89baa3a1abc739200cd3200472b4d2f475eabc4f3/68747470733a2f2f692e6d6565652e636f6d2e74772f5a554f713475342e706e67)